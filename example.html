<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>CrossXHR demo</title>
    </head>
    <body>
        <h1>Cross XHR demo</h1>
        <em>This demo requires flash to be installed in your browser</em>

        <p>Click the "test cross domain ajax" button to load <a href="http://www.pliantdev.com/support/test.xml">http://www.pliantdev.com/support/test.xml</a> using an AJAX call.</p>

        <input type="button" onclick="test_get()" value="test cross-domain ajax">

        <p>Click the "test error detection" button to attempt to load an invalid URL "http://www.pliantdev.com/support/does-not-exist.xml"</p>
        <input type="button" onclick="test_bad()" value="test error detection">

        <p>Click the "test error detection" button to attempt to load an invalid URL "http://www.pliantdev.com/support/does-not-exist.xml"</p>
        <input type="button" onclick="test_post()" value="test post request">

        <p>It is instructive to view the HTML source of this page. More information can be found at the <a href="http://code.google.com/p/crossxhr/">CrossXHR homepage</a>.</p>

        <script src="https://cdn.findawayworld.com/static/libs/underscore.js/1.5.1/underscore-min.js"></script>
        <script src="dist/CrossXHR-0.1.0.min.js"></script>
        <script>
            setupCrossXHR('https://cdn.findawayworld.com/static/swf/vendor/crossxhr.swf');
            var parameterize = function (object) {
                var str = '';
                _.each(object, function (item, index, key) {
                    var param = key + '=' + object[key];
                    str += index===0 ? param : '&' + param;
                });
                return str;
            };
            var makeRequest = function (opts) {
                var o = _.extend({
                        method: 'GET',
                        dataType: 'text',
                        data: null,
                        headers: {}
                    }, opts),
                    params,
                    request = new CrossXHR();

                request.onload = function () {
                    if (request.readyState == 4) {
                        try {
                            if (request.status != 200) {
                                alert('error detected 1');
                            } else {
                                // ok, process...
                                alert("got data: " + request.responseText);
                            }
                        } catch(e) {
                            alert('error detected 2');
                        }
                    }
                };

                request.open(o.method, o.url);

                if (o.headers && _.keys(o.headers).length) {
                    _.each(o.headers, function (item, index, key) {
                        request.setRequestHeader(key, item);
                    });
                }

                if (o.data) {
                    params = parameterize(o.data);
                    request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    //request.setRequestHeader("Content-length", params.length);
                }

                request.send(params);
            };

            function test_get() {
                makeRequest({
                    url: 'http://crossxhrtest.findawayworld.com/example.json',
                    method: 'GET'
                });
            }
            function test_bad() {
                makeRequest({
                    url: 'http://crossxhrtest.findawayworld.com/x.json',
                    method: 'GET'
                });
            }
            function test_post() {
                makeRequest({
                    url: 'http://crossxhrtest.findawayworld.com/example.json',
                    method: 'POST',
                    data: {
                        foo:'bar',
                        bar:'baz'
                    }
                })
            }
        </script>
    </body>
</html>
